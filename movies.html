<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Movies</title>
  <link rel="stylesheet" href="data/css/movies.css">
</head>
<body>

  <div class="site-title">
    <img src="data/img/movie.png" alt="Movies">
    <span> My Movies</span>
  </div>

  <div class="filter-grid">
    <div>
      <input type="text" id="search" placeholder="Search movie" />

      <select id="languageFilter">
        <option value="">All Languages</option>
      </select>

      <select id="yearFilter">
        <option value="">All Years</option>
      </select>

      <select id="genreFilter">
        <option value="">All Genres</option>
      </select>

      <button onclick="applyFilters()">Filter</button>
    </div>
  </div>

  <div id="loader" class="loader"></div>
  <div class="song-list" id="movieList"></div>

  <div class="pagination">
    <button onclick="prevPage()">
      <img src="data/img/prev-icon.png" alt="Prev" width="20">
    </button>

    <span id="pageInfo">Page 1 of 1</span>

    <button onclick="nextPage()">
      <img src="data/img/next-icon.png" alt="Next" width="20">
    </button>

    <input type="number" id="jumpPage" placeholder="Jump to" min="1">
    <button onclick="jumpToPage()" id="jumpBtn">Go</button>
  </div>

<script>
let data = [];
let filtered = [];
let currentPage = 1;
const pageSize = 10;
let previousFilterValues = "";

const listDiv = document.getElementById("movieList");
const langFilter = document.getElementById("languageFilter");
const yearFilter = document.getElementById("yearFilter");
const genreFilter = document.getElementById("genreFilter");
const pageInfo = document.getElementById("pageInfo");

fetch("data/movies.json")
  .then(res => res.json())
  .then(json => {
    data = json;
    document.getElementById("loader").style.display = "none";
    populateFilters(data);
    applyFilters(true);
  })
  .catch(err => {
    listDiv.innerHTML = `<p style="color:red;">Error loading movies.json</p>`;
    console.error(err);
  });

function populateFilters(data) {
  [...new Set(data.map(d => d[1]))]
    .forEach(l => langFilter.innerHTML += `<option value="${l}">${l}</option>`);

  [...new Set(data.map(d => String(d[2])))]
    .sort((a,b) => a.localeCompare(b, undefined, {numeric:true}))
    .forEach(y => yearFilter.innerHTML += `<option value="${y}">${y}</option>`);

  const genres = new Set();
  data.forEach(d => d[4].genre.forEach(g => genres.add(g)));
  [...genres].sort()
    .forEach(g => genreFilter.innerHTML += `<option value="${g}">${g}</option>`);
}

function applyFilters(isFirstLoad = false) {
  const search = document.getElementById("search").value.trim().toLowerCase();
  const lang = langFilter.value;
  const year = yearFilter.value;
  const genre = genreFilter.value;

  const current = `${search}|${lang}|${year}|${genre}`;
  if (!isFirstLoad && current === previousFilterValues) return;
  previousFilterValues = current;

  filtered = data.filter(([title, l, y, img, meta]) => {
    if (lang && l !== lang) return false;
    if (year && String(y) !== year) return false;
    if (genre && !meta.genre.includes(genre)) return false;
    if (search && !title.toLowerCase().includes(search)) return false;
    return true;
  });

  currentPage = 1;
  renderList();
}

function renderList() {
  listDiv.innerHTML = "";

  const totalPages = Math.ceil(filtered.length / pageSize) || 1;
  currentPage = Math.min(Math.max(1, currentPage), totalPages);
  pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

  const start = (currentPage - 1) * pageSize;
  const visible = filtered.slice(start, start + pageSize);

  visible.forEach(([title, lang, year, img, meta]) => {
    const block = document.createElement("div");
    block.className = "album";

    const cover = document.createElement("img");
    cover.src = `/data/album/${img}`;
    cover.alt = title;
    cover.className = "cover";
    cover.onerror = () => cover.src = "/data/img/default.jpg";

    const info = document.createElement("div");
    info.className = "album-info";

    info.innerHTML = `
      <strong>${title}</strong> (${lang}, ${year})
      <div class="singer">Director: ${meta.director}</div>
      <div class="singer">Cast: ${meta.cast.join(", ")}</div>
      <div class="singer">Genre: ${meta.genre.join(", ")}</div>
      <div class="singer">Rating: ${meta.rating}</div>
    `;

    block.appendChild(cover);
    block.appendChild(info);
    listDiv.appendChild(block);
  });
}

function prevPage() {
  if (currentPage > 1) {
    currentPage--;
    renderList();
  }
}

function nextPage() {
  const totalPages = Math.ceil(filtered.length / pageSize);
  if (currentPage < totalPages) {
    currentPage++;
    renderList();
  }
}

function jumpToPage() {
  const input = document.getElementById("jumpPage");
  const value = parseInt(input.value);
  const totalPages = Math.ceil(filtered.length / pageSize);

  if (!value || value < 1 || value > totalPages) {
    document.getElementById("jumpBtn").title =
      `Enter number between 1 and ${totalPages}`;
    return;
  }

  document.getElementById("jumpBtn").title = "";
  currentPage = value;
  renderList();
}
</script>

</body>
</html>